#!/usr/bin/env bash

# Usage: generate_config [ restart | reload ]
#  Options:
#    restart:       Restarts i3 after generating config
#    reload:        Reloads i3 config after generating config

i3_home="$HOME/.i3"
i3_config="$i3_home/config"
i3_configs="$i3_home/config.d"
i3_includes="$i3_configs/include.conf"

if [ ! -f "$i3_includes" ] ; then
    echo "ERROR:"
    echo "Please create the includes file:"
    echo "$i3_includes"
    exit 1
fi

if [ ! -f "$i3_configs/base.conf" ] ; then
    echo "ERROR:"
    echo "Please create the includes file:"
    echo "$i3_configs/base.conf"
    exit 1
fi

[[ -f "$i3_config"  ]] && rm "$i3_config"

echo "### DO NOT EDIT THIS FILE, IT IS BEING GENERATED" > "$i3_config"
echo "### EDIT FILES IN ~/.i3/config.d/**/*" >> "$i3_config"
echo "### GENERATE FILES BY RUNNING ~/.i3/generate_config" >> "$i3_config"
echo "" >> "$i3_config"

add_config() {
    cat "$i3_configs/$1" >> "$i3_config"
}

while read line ; do
    # stripped_line="$(echo -e $line | tr -d '[:space:]')"
    if [[ "$line" == "include "* ]] ; then
        config_file="$(echo $line | sed 's/include//;s/ //')"
        add_config "$config_file"
    fi
done < "$i3_includes"

if [[ "$1" == "restart" || "$1" == reload ]] ; then
    i3-msg "$1"
fi
